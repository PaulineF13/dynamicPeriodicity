---
title: Periodicity with plotly
output: html_document
params:
 gff3:
    label: "Gff3 dataset (Caution: On chromosome at a time):"
    value: annotation.gff3
    input: file
 data:
    label: "Input dataset:"
    value: results.csv
    input: file
 annotation:
    label: "Annotation:"
    value: All
    input: select
    choices: [All, CDS, gene, five_prime_UTR and three_prime_UTR, transcript]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## First Graph

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
```{r include=FALSE}
library(plotly)
```

```{r echo=FALSE, message=FALSE}

count<-read.table(params$data)

couleur<-NULL
for(i in 1:nrow(count)){
  un<-(count$V1[i]-1)
  deux<-(count$V1[i]-2)
  if(count$V1[i]==1) {
    couleur<-c(couleur,"green")
  } 
  else if(count$V1[i]==2) {
    couleur<-c(couleur,"red")
  } 
  else if(count$V1[i]==3) {
    couleur<-c(couleur,"blue")
  }
  else if(un%%3==0) {
    couleur<-c(couleur,"green")
  }
  else if(deux%%3==0) {
    couleur<-c(couleur,"red")
  } 
  else
    couleur<-c(couleur,"blue")
}
count<-cbind(count,couleur)

gff<-read.table(params$gff3,sep="\t",header=F)
annot<-params$annotation
if(annot=="CDS"){
  gff_soft<-subset(gff,gff$V3=="CDS")
} else if(annot=="gene"){
  gff_soft<-subset(gff,gff$V3=="gene")
} else if(annot=="five_prime_UTR and three_prime_UTR"){
  gff_soft<-subset(gff,gff$V3=="five_prime_UTR" | gff$V3=="three_prime_UTR")
} else if(annot=="transcript"){
  if("transcript" %in% gff$V3){
    gff_soft<-subset(gff,gff$V3=="transcript")
  }
  else{
    gff_soft<-subset(gff,gff$V3=="five_prime_UTR" | gff$V3=="three_prime_UTR" | gff$V3=="CDS")
  }
} else{
  gff_soft<-gff
}

stage<-NULL
for (i in 1:nrow(gff_soft)){
  un<-(gff_soft$V4[i]-1)
  deux<-(gff_soft$V4[i]-2)
  if(gff_soft$V1[i]==1) {
    phase<-1
  } 
  else if(gff_soft$V1[i]==2) {
    phase<-2
  } 
  else if(gff_soft$V1[i]==3) {
    phase<-3
  }
  else if(un%%3==0) {
    phase<-1
  }
  else if(deux%%3==0) {
    phase<-2
  } 
  else
    phase<-3
  
  if(gff_soft$V7[i]=="-"){
    if(phase==1){
      phase<-3
    }
    else if (phase==3){
      phase<-1
    }
  }
  
  stage<-c(stage,phase)
}

gff_soft<-cbind(gff_soft,stage)

p <- plot_ly(count, x = ~V1, y = ~V2, type = 'bar', 
             marker = list(color= ~couleur, line = list(width = 0))) %>%
  layout(title = "Periodicity",
         xaxis = list(title = "Position"),
         yaxis = list(title = "Count", range = c(0,2000)))

p2 <- plot_ly()   %>%
  layout(yaxis = list(title = 'Annotation', 
                      fixedrange=T,
                      range = c(-1.5,1.5),
                      zeroline = F,
                      showline = F,
                      showticklabels = F,
                      showgrid = F),
         xaxis = list( range = c(count$V1[1], count$V1[nrow(count)]),
                       title = "Position",
                       zeroline = T,
                       showline = T,
                       showticklabels = T,
                       showgrid = F)) 
for(i in 1:nrow(gff_soft)){
  if(gff_soft$stage[i]==1){
    p2 <- add_trace(p2, 
                    x = c(gff_soft$V4[i],gff_soft$V5[i]),
                    y = rep(1,2) ,
                    type="scatter",
                    mode = 'lines+markers',
                    text = gsub(";","\n",gff_soft$V9[i]) ,
                    hoverinfo = 'text',
                    showlegend = F,
                    marker = list(color= "green", width = 4),
                    line=list(color="green")
    )
  }
  else if(gff_soft$stage[i]==2) 
    p2 <- add_trace(p2, 
                    x = c(gff_soft$V4[i],gff_soft$V5[i]),
                    y = rep(0,2) ,
                    type="scatter",
                    mode = 'lines+markers',
                    text = gsub(";","\n",gff_soft$V9[i]) ,
                    hoverinfo = 'text',
                    showlegend = F,
                    marker = list(color= "red", width = 4),
                    line=list(color="red")
    )
  else if(gff_soft$stage[i]==3) 
    p2 <- add_trace(p2, 
                    x = c(gff_soft$V4[i],gff_soft$V5[i]),
                    y = rep(-1,2) ,
                    type="scatter",
                    mode = 'lines+markers',
                    text = gsub(";","\n",gff_soft$V9[i]) ,
                    hoverinfo = 'text',
                    showlegend = F,
                    marker = list(color= "blue", width = 4),
                    line=list(color="blue")
    )
}

subplot(p, p2, shareX=TRUE,nrows = 2, heights = c(0.8, 0.2))
```

## Version 
```{r echo=FALSE}
si <- sessionInfo()
```
### R version  
```{r echo=FALSE}
R.Version()$version.string
```
### Platform
```{r echo=FALSE}
si[[1]]$platform
```
### Loaded packages

```{r echo=FALSE }
sort(unlist(lapply(si$loadedOnly, function(x){paste(x$Package, x$Version)})))
```

### Plotly version
```{r echo=FALSE}
packageVersion("plotly")
```
